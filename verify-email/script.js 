import { auth } from '../js/auth.js';
import { onAuthStateChanged, sendEmailVerification, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

const userEmailEl = document.querySelector('.user-email');
const resendBtn = document.getElementById('resend-verification-btn');
const logoutBtn = document.getElementById('verification-logout-btn');
const messageArea = document.getElementById('message-area');

// --- Timer Elements ---
const resendTimerText = document.getElementById('resend-timer-text');
const countdownTimer = document.getElementById('countdown-timer');

let verificationCheckInterval = null;
let countdownInterval = null;

// --- Timer Function ---
function startTimer(durationInSeconds) {
    // Clear any existing timer
    if (countdownInterval) clearInterval(countdownInterval);

    let count = durationInSeconds;
    
    // Disable button and show timer
    resendBtn.disabled = true;
    resendTimerText.style.display = 'block';
    countdownTimer.textContent = count;
    
    countdownInterval = setInterval(() => {
        count--;
        countdownTimer.textContent = count;
        if (count <= 0) {
            clearInterval(countdownInterval);
            resendBtn.disabled = false;
            resendTimerText.style.display = 'none'; // Hide the timer text
        }
    }, 1000);
}

onAuthStateChanged(auth, (user) => {
    if (user) {
        // If user is already verified, send them to the dashboard
        if (user.emailVerified) {
            window.location.replace('/dashboard/');
            return;
        }

        // Display the user's email
        userEmailEl.textContent = user.email;

        // --- Start the initial 10-second countdown ---
        startTimer(10);

        // Start checking for verification every 3 seconds
        verificationCheckInterval = setInterval(async () => {
            await user.reload();
            // We check the user object directly from auth, not the one from the closure
            if (auth.currentUser && auth.currentUser.emailVerified) {
                clearInterval(verificationCheckInterval);
                window.location.replace('/dashboard/');
            }
        }, 3000);

    } else {
        // If no user is logged in, they can't be here. Send them to login.
        window.location.replace('/login/');
    }
});

resendBtn.addEventListener('click', async () => {
    if (!auth.currentUser) return;
    
    // Disable button immediately
    resendBtn.disabled = true; 
    resendBtn.textContent = 'Sending...';
    messageArea.style.display = 'none'; // Hide old messages

    try {
        await sendEmailVerification(auth.currentUser);
        messageArea.textContent = 'A new verification email has been sent.';
        messageArea.className = 'success-message';
        messageArea.style.display = 'block';
    } catch (error) {
        messageArea.textContent = 'Failed to send email. Please try again soon.';
        messageArea.className = 'error-message';
        messageArea.style.display = 'block';
    } finally {
        resendBtn.textContent = 'Resend Verification Email';
        // --- Start a new 30-second cooldown to prevent spam ---
        startTimer(30); 
    }
});

logoutBtn.addEventListener('click', () => {
    if (verificationCheckInterval) clearInterval(verificationCheckInterval);
    if (countdownInterval) clearInterval(countdownInterval); // Clear timers on logout
    signOut(auth);
});